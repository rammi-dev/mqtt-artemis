apiVersion: v1
kind: Namespace
metadata:
  name: test
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-test
  namespace: test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx-test
  template:
    metadata:
      labels:
        app: nginx-test
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            cpu: 50m
            memory: 64Mi
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html
        configMap:
          name: nginx-test-html
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-test-html
  namespace: test
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Test dla Pytni :)</title>
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                color: white;
            }
            .container {
                text-align: center;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 50px;
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
                border: 1px solid rgba(255, 255, 255, 0.18);
                max-width: 600px;
            }
            h1 {
                font-size: 2.5em;
                margin: 20px 0;
                animation: fadeIn 1s;
            }
            .status {
                font-size: 1.3em;
                margin: 20px 0;
                animation: fadeIn 1.5s;
            }
            .check {
                color: #4ade80;
                font-size: 5em;
                animation: scaleIn 0.5s;
                font-weight: bold;
            }
            .info {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 10px;
                padding: 20px;
                margin: 20px 0;
                animation: fadeIn 2s;
            }
            .info-item {
                margin: 15px 0;
                font-size: 1.1em;
                text-align: left;
            }
            .label {
                color: #fbbf24;
                font-weight: bold;
                display: inline-block;
                min-width: 180px;
            }
            .footer {
                margin-top: 30px;
                font-size: 0.9em;
                opacity: 0.8;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes scaleIn {
                from { transform: scale(0); }
                to { transform: scale(1); }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="check">&#10003;</div>
            <h1>IoT anaytics deployment status</h1>
            <div class="status">GKE Cluster is Running</div>
            
            <div class="info">
                <div class="info-item">
                    <span class="label">&#10003; cert-manager:</span> Deployed
                </div>
                <div class="info-item">
                    <span class="label">&#10003; ingress-nginx:</span> Deployed
                </div>
                <div class="info-item">
                    <span class="label">&#10003; SSL Certificate:</span> <span id="ssl-status">Checking...</span>
                </div>
                <div class="info-item">
                    <span class="label">&#127760; Domain:</span> <span id="hostname"></span>
                </div>
                <div class="info-item">
                    <span class="label">&#128274; Protocol:</span> <span id="protocol"></span>
                </div>
            </div>

            <h2>Available Services</h2>
            <div class="info">
                <div class="info-item">
                    <span class="label">&#128640; Artemis Console:</span> 
                    <a id="artemis-link" href="#" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold; background: white; padding: 5px 10px; border-radius: 5px;">Open Console</a>
                </div>
                <div class="info-item">
                    <span class="label">üîê Keycloak:</span> 
                    <a id="keycloak-link" href="#" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold; background: white; padding: 5px 10px; border-radius: 5px;">Open Admin</a>
                </div>
            </div>
            
            <div class="footer">
                Powered by Kubernetes on GKE
            </div>
        </div>
        
        <script>
            // Display current URL info
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('protocol').textContent = window.location.protocol.toUpperCase();
            
            // Extract base domain (IP.nip.io format) by removing the subdomain
            const hostname = window.location.hostname;
            // Remove 'test.' prefix to get base domain like '35-206-88-67.nip.io'
            const baseDomain = hostname.replace(/^test\./, '');
            
            // Set dynamic service URLs
            document.getElementById('artemis-link').href = `https://artemis.${baseDomain}/console`;
            document.getElementById('keycloak-link').href = `https://keycloak.${baseDomain}/admin/`;
            
            // Check SSL status
            if (window.location.protocol === 'https:') {
                document.getElementById('ssl-status').textContent = 'Active \u2713';
                document.getElementById('ssl-status').style.color = '#4ade80';
            } else {
                document.getElementById('ssl-status').textContent = 'Pending (use HTTPS)';
                document.getElementById('ssl-status').style.color = '#fbbf24';
            }
        </script>
    </body>
    </html>
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-test
  namespace: test
spec:
  selector:
    app: nginx-test
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-test
  namespace: test
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"  # Using production for trusted certificate
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - test.35.206.88.67.nip.io
    secretName: nginx-test-tls
  rules:
  - host: test.35.206.88.67.nip.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-test
            port:
              number: 80

