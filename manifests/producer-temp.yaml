apiVersion: batch/v1
kind: Job
metadata:
  name: producer-job-final
  namespace: default
spec:
  template:
    spec:
      containers:
      - name: producer
        image: python:3.9-slim
        command: ["/bin/sh", "-c"]
        args:
        - |
          pip install "paho-mqtt<2.0.0"
          python3 -c "
          import paho.mqtt.client as mqtt
          import time
          import json
          import random
          
          broker = 'artemis-activemq-artemis-master-0.artemis-activemq-artemis-master.default.svc.cluster.local'
          port = 1883
          topic = 'raw-telemetry'
          
          client = mqtt.Client('producer_final')
          client.connect(broker, port)
          
          for i in range(100):
              data = {
                  'timestamp': str(time.time()),
                  'device_id': 'sensor-' + str(random.randint(1, 5)),
                  'temperature': round(random.uniform(20.0, 30.0), 2),
                  'pressure': round(random.uniform(1000.0, 1020.0), 2),
                  'status': 'OK',
                  'msg_id': i
              }
              payload = json.dumps(data)
              client.publish(topic, payload)
              print(f'Sent: {payload}')
              time.sleep(0.1)
          
          client.disconnect()
          "
      restartPolicy: Never
