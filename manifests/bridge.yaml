apiVersion: v1
kind: ConfigMap
metadata:
  name: bridge-script
  namespace: default
data:
  bridge.py: |
    import os
    import json
    import time
    import paho.mqtt.client as mqtt
    from kafka import KafkaProducer

    # Config
    MQTT_BROKER = os.getenv("MQTT_BROKER", "artemis-activemq-artemis-master-0.artemis-activemq-artemis-master.default.svc.cluster.local")
    MQTT_TOPIC = os.getenv("MQTT_TOPIC", "raw-telemetry")
    KAFKA_BOOTSTRAP = os.getenv("KAFKA_BOOTSTRAP", "telemetry-cluster-kafka-bootstrap.kafka.svc:9092")
    KAFKA_TOPIC = os.getenv("KAFKA_TOPIC", "raw-telemetry")

    # Kafka Producer
    producer = KafkaProducer(
        bootstrap_servers=KAFKA_BOOTSTRAP,
        value_serializer=lambda v: json.dumps(v).encode('utf-8')
    )

    def on_connect(client, userdata, flags, rc):
        print(f"Connected with result code {rc}")
        client.subscribe(MQTT_TOPIC)

    def on_message(client, userdata, msg):
        try:
            payload = json.loads(msg.payload.decode())
            print(f"Received: {payload}")
            producer.send(KAFKA_TOPIC, payload)
        except Exception as e:
            print(f"Error bridging message: {e}")

    client = mqtt.Client()
    client.on_connect = on_connect
    client.on_message = on_message

    print(f"Connecting to MQTT {MQTT_BROKER}...")
    client.connect(MQTT_BROKER, 1883, 60)
    print("Bridge Started")
    client.loop_forever()
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: artemis-kafka-bridge
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bridge
  template:
    metadata:
      labels:
        app: bridge
    spec:
      containers:
      - name: bridge
        image: python:3.9-slim
        command: ["/bin/sh", "-c"]
        args: ["pip install paho-mqtt kafka-python && python3 -u /app/bridge.py"]
        env:
        - name: MQTT_BROKER
          value: "artemis-activemq-artemis-master-0.artemis-activemq-artemis-master.default.svc.cluster.local"
        - name: KAFKA_BOOTSTRAP
          value: "telemetry-cluster-kafka-bootstrap.kafka.svc.cluster.local:9092"
        volumeMounts:
        - name: script
          mountPath: /app
      volumes:
      - name: script
        configMap:
          name: bridge-script
