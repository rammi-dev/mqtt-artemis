apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "artemis.fullname" . }}-broker-xml
  labels:
    {{- include "artemis.labels.standard" . | nindent 4 }}
data:
  broker-master.xml: |
    <?xml version='1.0'?>
    <configuration xmlns="urn:activemq" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:activemq /schema/artemis-configuration.xsd">
       <core xmlns="urn:activemq:core" xsi:schemaLocation="urn:activemq:core ">
          <name>0.0.0.0</name>
          
          <persistence-enabled>true</persistence-enabled>
          <journal-type>NIO</journal-type> <!-- Defaulting to NIO for compatibility, or AIO if preferred -->
          <paging-directory>data/paging</paging-directory>
          <bindings-directory>data/bindings</bindings-directory>
          <journal-directory>data/journal</journal-directory>
          <large-messages-directory>data/large-messages</large-messages-directory>

          <acceptors>
             <acceptor name="artemis">tcp://0.0.0.0:61616?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;amqpMinLargeMessageSize=102400;protocols=CORE,AMQP,STOMP,HORNETQ,MQTT,OPENWIRE;useEpoll=true;amqpCredits=1000;amqpLowCredits=300;amqpDuplicateDetection=true</acceptor>
             <acceptor name="amqp">tcp://0.0.0.0:5672?protocols=AMQP;useEpoll=true</acceptor>
             <acceptor name="stomp">tcp://0.0.0.0:61613?protocols=STOMP;useEpoll=true</acceptor>
             <acceptor name="hornetq">tcp://0.0.0.0:5445?protocols=HORNETQ,STOMP;useEpoll=true</acceptor>
             <acceptor name="mqtt">tcp://0.0.0.0:1883?protocols=MQTT;useEpoll=true</acceptor>
          </acceptors>

          <security-settings>
             <security-setting match="#">
                <permission type="createNonDurableQueue" roles="amq"/>
                <permission type="deleteNonDurableQueue" roles="amq"/>
                <permission type="createDurableQueue" roles="amq"/>
                <permission type="deleteDurableQueue" roles="amq"/>
                <permission type="createAddress" roles="amq"/>
                <permission type="deleteAddress" roles="amq"/>
                <permission type="consume" roles="amq"/>
                <permission type="browse" roles="amq"/>
                <permission type="send" roles="amq"/>
                <permission type="manage" roles="amq"/>
             </security-setting>
          </security-settings>

          <address-settings>
             <address-setting match="activemq.management.#">
                <dead-letter-address>DLQ</dead-letter-address>
                <expiry-address>ExpiryQueue</expiry-address>
                <redelivery-delay>0</redelivery-delay>
                <max-size-bytes>-1</max-size-bytes>
                <message-counter-history-day-limit>10</message-counter-history-day-limit>
                <address-full-policy>PAGE</address-full-policy>
                <auto-create-queues>true</auto-create-queues>
                <auto-create-addresses>true</auto-create-addresses>
             </address-setting>
             <address-setting match="#">
                <dead-letter-address>DLQ</dead-letter-address>
                <expiry-address>ExpiryQueue</expiry-address>
                <redelivery-delay>0</redelivery-delay>
                <max-size-bytes>-1</max-size-bytes>
                <message-counter-history-day-limit>10</message-counter-history-day-limit>
                <address-full-policy>PAGE</address-full-policy>
                <auto-create-queues>true</auto-create-queues>
                <auto-create-addresses>true</auto-create-addresses>
             </address-setting>
          </address-settings>

          <addresses>
             <address name="DLQ"><anycast><queue name="DLQ" /></anycast></address>
             <address name="ExpiryQueue"><anycast><queue name="ExpiryQueue" /></anycast></address>
             {{- if .Values.queues }}
               {{- range .Values.queues }}
               <address name="{{ .name }}">
                 <anycast>
                   <queue name="{{ .name }}" />
                 </anycast>
               </address>
               {{- end }}
             {{- end }}
          </addresses>

          <!-- HA Policy for MASTER -->
          <ha-policy>
            <replication>
              <master>
                <check-for-live-server>true</check-for-live-server>
                <!-- Group name usually matches, we can genericize it -->
              </master>
            </replication>
          </ha-policy>

          <!-- Cluster Connections -->
          <cluster-user>{{ .Values.artemisUser | default "clusterUser" }}</cluster-user>
          <cluster-password>{{ .Values.artemisPassword | default "clusterPass" }}</cluster-password>
          <cluster-connections>
            <cluster-connection name="my-cluster">
              <connector-ref>netty-connector</connector-ref>
              <retry-interval>500</retry-interval>
              <use-duplicate-detection>true</use-duplicate-detection>
              <message-load-balancing>ON_DEMAND</message-load-balancing>
              <max-hops>1</max-hops>
              <static-connectors>
                {{- $fullname := include "artemis.fullname" . -}}
                {{- $releaseName := .Release.Name -}}
                {{- $namespace := .Release.Namespace -}}
                <connector-ref>slave-connector</connector-ref>
              </static-connectors>
            </cluster-connection>
          </cluster-connections>

          <connectors>
            <connector name="netty-connector">tcp://{{ include "artemis.fullname" . }}-master-0.{{ include "artemis.fullname" . }}-master.{{ .Release.Namespace }}.svc.cluster.local:61616</connector>
            <connector name="slave-connector">tcp://{{ include "artemis.fullname" . }}-slave-0.{{ include "artemis.fullname" . }}-slave.{{ .Release.Namespace }}.svc.cluster.local:61616</connector>
          </connectors>

       </core>
    </configuration>

  broker-slave.xml: |
    <?xml version='1.0'?>
    <configuration xmlns="urn:activemq" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:activemq /schema/artemis-configuration.xsd">
       <core xmlns="urn:activemq:core" xsi:schemaLocation="urn:activemq:core ">
          <name>0.0.0.0</name>

          <persistence-enabled>true</persistence-enabled>
          <journal-type>NIO</journal-type>
          <paging-directory>data/paging</paging-directory>
          <bindings-directory>data/bindings</bindings-directory>
          <journal-directory>data/journal</journal-directory>
          <large-messages-directory>data/large-messages</large-messages-directory>

          <acceptors>
             <acceptor name="artemis">tcp://0.0.0.0:61616?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;amqpMinLargeMessageSize=102400;protocols=CORE,AMQP,STOMP,HORNETQ,MQTT,OPENWIRE;useEpoll=true;amqpCredits=1000;amqpLowCredits=300;amqpDuplicateDetection=true</acceptor>
             <acceptor name="amqp">tcp://0.0.0.0:5672?protocols=AMQP;useEpoll=true</acceptor>
             <acceptor name="stomp">tcp://0.0.0.0:61613?protocols=STOMP;useEpoll=true</acceptor>
             <acceptor name="hornetq">tcp://0.0.0.0:5445?protocols=HORNETQ,STOMP;useEpoll=true</acceptor>
             <acceptor name="mqtt">tcp://0.0.0.0:1883?protocols=MQTT;useEpoll=true</acceptor>
          </acceptors>

          <security-settings>
             <security-setting match="#">
                <permission type="createNonDurableQueue" roles="amq"/>
                <permission type="deleteNonDurableQueue" roles="amq"/>
                <permission type="createDurableQueue" roles="amq"/>
                <permission type="deleteDurableQueue" roles="amq"/>
                <permission type="createAddress" roles="amq"/>
                <permission type="deleteAddress" roles="amq"/>
                <permission type="consume" roles="amq"/>
                <permission type="browse" roles="amq"/>
                <permission type="send" roles="amq"/>
                <permission type="manage" roles="amq"/>
             </security-setting>
          </security-settings>

          <address-settings>
             <address-setting match="activemq.management.#">
                <dead-letter-address>DLQ</dead-letter-address>
                <expiry-address>ExpiryQueue</expiry-address>
                <redelivery-delay>0</redelivery-delay>
                <max-size-bytes>-1</max-size-bytes>
                <message-counter-history-day-limit>10</message-counter-history-day-limit>
                <address-full-policy>PAGE</address-full-policy>
                <auto-create-queues>true</auto-create-queues>
                <auto-create-addresses>true</auto-create-addresses>
             </address-setting>
             <address-setting match="#">
                <dead-letter-address>DLQ</dead-letter-address>
                <expiry-address>ExpiryQueue</expiry-address>
                <redelivery-delay>0</redelivery-delay>
                <max-size-bytes>-1</max-size-bytes>
                <message-counter-history-day-limit>10</message-counter-history-day-limit>
                <address-full-policy>PAGE</address-full-policy>
                <auto-create-queues>true</auto-create-queues>
                <auto-create-addresses>true</auto-create-addresses>
             </address-setting>
          </address-settings>

          <addresses>
             <address name="DLQ"><anycast><queue name="DLQ" /></anycast></address>
             <address name="ExpiryQueue"><anycast><queue name="ExpiryQueue" /></anycast></address>
             {{- if .Values.queues }}
               {{- range .Values.queues }}
               <address name="{{ .name }}">
                 <anycast>
                   <queue name="{{ .name }}" />
                 </anycast>
               </address>
               {{- end }}
             {{- end }}
          </addresses>

          <!-- HA Policy for SLAVE -->
          <ha-policy>
            <replication>
              <slave>
                <allow-failback>true</allow-failback>
                <!-- Group name usually matches -->
              </slave>
            </replication>
          </ha-policy>

          <!-- Cluster Connections -->
          <cluster-user>{{ .Values.artemisUser | default "clusterUser" }}</cluster-user>
          <cluster-password>{{ .Values.artemisPassword | default "clusterPass" }}</cluster-password>
          <cluster-connections>
            <cluster-connection name="my-cluster">
              <connector-ref>netty-connector</connector-ref>
              <retry-interval>500</retry-interval>
              <use-duplicate-detection>true</use-duplicate-detection>
              <message-load-balancing>ON_DEMAND</message-load-balancing>
              <max-hops>1</max-hops>
              <static-connectors>
                 <connector-ref>master-connector</connector-ref>
              </static-connectors>
            </cluster-connection>
          </cluster-connections>

          <connectors>
            <connector name="netty-connector">tcp://{{ include "artemis.fullname" . }}-slave-0.{{ include "artemis.fullname" . }}-slave.{{ .Release.Namespace }}.svc.cluster.local:61616</connector>
            <connector name="master-connector">tcp://{{ include "artemis.fullname" . }}-master-0.{{ include "artemis.fullname" . }}-master.{{ .Release.Namespace }}.svc.cluster.local:61616</connector>
          </connectors>

       </core>
    </configuration>
