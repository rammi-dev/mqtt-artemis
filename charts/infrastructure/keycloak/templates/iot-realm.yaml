apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: iot-realm
  labels:
    app: keycloak
spec:
  keycloakCRName: keycloak
  realm:
    realm: iot
    enabled: true
    displayName: IoT Load Testing
    sslRequired: external
    registrationAllowed: false
    loginWithEmailAllowed: true
    duplicateEmailsAllowed: false
    resetPasswordAllowed: false
    editUsernameAllowed: false
    
    # Session timeouts (in seconds)
    ssoSessionIdleTimeout: 1800        # 30 minutes idle
    ssoSessionMaxLifespan: 28800       # 8 hours max
    accessTokenLifespan: 300           # 5 minutes
    accessTokenLifespanForImplicitFlow: 300
    
    roles:
      realm:
        - name: admin
          description: Full access to all applications
        - name: test-telemetry
          description: Access to telemetry tests and viewing test results
        - name: nifi-operator
          description: Operator access to NiFi (view and operate flows)
    
    clients:
      - clientId: iot-load-tester
        name: IoT Load Tester
        description: Load testing application for IoT protocols
        enabled: true
        publicClient: false
        secret: "test-secret"
        standardFlowEnabled: true
        implicitFlowEnabled: false
        directAccessGrantsEnabled: true
        serviceAccountsEnabled: false
        rootUrl: ""
        redirectUris:
          - "https://loadtest.{{ .Values.domain }}/*"
          - "https://auth.{{ .Values.domain }}/*"
          - "http://localhost:8090/*"
        webOrigins:
          - "*"
        fullScopeAllowed: true
        defaultClientScopes:
          - web-origins
          - acr
          - roles
          - profile
          - email
        # Ensure roles are included in tokens
        protocolMappers:
          - name: realm-roles
            protocol: openid-connect
            protocolMapper: oidc-usermodel-realm-role-mapper
            consentRequired: false
            config:
              multivalued: "true"
              userinfo.token.claim: "true"
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: "roles"
              jsonType.label: "String"
          - name: groups
            protocol: openid-connect
            protocolMapper: oidc-usermodel-realm-role-mapper
            consentRequired: false
            config:
              multivalued: "true"
              userinfo.token.claim: "true"
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: "groups"
              jsonType.label: "String"
      
      # NiFi OIDC Client
      - clientId: nifi
        name: Apache NiFi
        description: Apache NiFi data flow management
        enabled: true
        publicClient: false
        secret: "nifi-secret"
        standardFlowEnabled: true
        implicitFlowEnabled: false
        directAccessGrantsEnabled: true
        serviceAccountsEnabled: false
        rootUrl: ""
        redirectUris:
          - "https://nifi.{{ .Values.domain }}/*"
        webOrigins:
          - "*"
        fullScopeAllowed: true
        defaultClientScopes:
          - web-origins
          - acr
          - roles
          - profile
          - email
        protocolMappers:
          - name: realm-roles
            protocol: openid-connect
            protocolMapper: oidc-usermodel-realm-role-mapper
            consentRequired: false
            config:
              multivalued: "true"
              userinfo.token.claim: "true"
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: "roles"
              jsonType.label: "String"
    
    users:
      - username: admin
        enabled: true
        firstName: Admin
        lastName: User
        email: admin@example.com
        credentials:
          - type: password
            value: admin
            temporary: false
        realmRoles:
          - admin
          - nifi-operator
      
      - username: test
        enabled: true
        firstName: Test
        lastName: User
        email: test@example.com
        credentials:
          - type: password
            value: test
            temporary: false
        realmRoles:
          - test-telemetry
          - nifi-operator

