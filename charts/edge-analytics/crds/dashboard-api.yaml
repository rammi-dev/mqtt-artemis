apiVersion: apps/v1
kind: Deployment
metadata:
  name: dashboard-api
  namespace: edge
  labels:
    app: dashboard-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dashboard-api
  template:
    metadata:
      labels:
        app: dashboard-api
    spec:
      containers:
        - name: api
          image: python:3.11-slim
          ports:
            - containerPort: 8000
          env:
            - name: REDIS_HOST
              value: "edge-analytics-redis-master.edge.svc.cluster.local"
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_PASSWORD
              value: "redis-secret"
          command:
            - /bin/bash
            - -c
            - |
              pip install fastapi uvicorn redis --quiet
              cat << 'EOF' > /app/main.py
              import os
              import json
              from fastapi import FastAPI, HTTPException
              from fastapi.middleware.cors import CORSMiddleware
              import redis

              app = FastAPI(title="Edge Analytics Dashboard API", version="1.0.0")

              # CORS for dashboard frontends
              app.add_middleware(
                  CORSMiddleware,
                  allow_origins=["*"],
                  allow_credentials=True,
                  allow_methods=["*"],
                  allow_headers=["*"],
              )

              # Redis connection
              r = redis.Redis(
                  host=os.getenv('REDIS_HOST', 'localhost'),
                  port=int(os.getenv('REDIS_PORT', '6379')),
                  password=os.getenv('REDIS_PASSWORD'),
                  decode_responses=True
              )

              @app.get("/health")
              def health_check():
                  """API health check"""
                  try:
                      r.ping()
                      return {"status": "healthy", "redis": "connected"}
                  except Exception as e:
                      return {"status": "unhealthy", "error": str(e)}

              @app.get("/api/dashboard/system-health")
              def get_system_health():
                  """Get overall system health metrics"""
                  data = r.get('dashboard:system_health')
                  if not data:
                      raise HTTPException(status_code=404, detail="No health data available")
                  return json.loads(data)

              @app.get("/api/dashboard/device-stats")
              def get_device_stats():
                  """Get per-device statistics (last 5 minutes)"""
                  data = r.get('dashboard:device_stats')
                  if not data:
                      raise HTTPException(status_code=404, detail="No device stats available")
                  return {"devices": json.loads(data)}

              @app.get("/api/dashboard/timeseries")
              def get_timeseries():
                  """Get time-series data (last hour, 1-minute buckets)"""
                  data = r.get('dashboard:timeseries_1h')
                  if not data:
                      raise HTTPException(status_code=404, detail="No timeseries data available")
                  return {"data": json.loads(data)}

              @app.get("/api/dashboard/latest-events")
              def get_latest_events():
                  """Get latest readings per device"""
                  data = r.get('dashboard:latest_events')
                  if not data:
                      raise HTTPException(status_code=404, detail="No latest events available")
                  return {"events": json.loads(data)}

              @app.get("/api/dashboard/hourly-stats")
              def get_hourly_stats():
                  """Get hourly aggregation (last 24 hours)"""
                  data = r.get('dashboard:hourly_stats_24h')
                  if not data:
                      raise HTTPException(status_code=404, detail="No hourly stats available")
                  return {"data": json.loads(data)}

              @app.get("/api/dashboard/all")
              def get_all_dashboard_data():
                  """Get all dashboard data in a single request"""
                  return {
                      "system_health": json.loads(r.get('dashboard:system_health') or '{}'),
                      "device_stats": json.loads(r.get('dashboard:device_stats') or '[]'),
                      "timeseries": json.loads(r.get('dashboard:timeseries_1h') or '[]'),
                      "latest_events": json.loads(r.get('dashboard:latest_events') or '[]'),
                      "hourly_stats": json.loads(r.get('dashboard:hourly_stats_24h') or '[]'),
                  }

              # ============================================
              # REAL-TIME ENDPOINTS (from NiFi Redis stream)
              # ============================================
              
              @app.get("/api/realtime/devices")
              def get_realtime_devices():
                  """Get real-time device states (updated by NiFi)"""
                  devices = []
                  # Scan for device:* keys set by NiFi PutRedisHashRecord
                  for key in r.scan_iter("device:*"):
                      data = r.hgetall(key)
                      if data:
                          data['device_id'] = key.replace('device:', '')
                          devices.append(data)
                  return {"devices": devices, "count": len(devices)}

              @app.get("/api/realtime/device/{device_id}")
              def get_device_state(device_id: str):
                  """Get current state of a specific device"""
                  data = r.hgetall(f"device:{device_id}")
                  if not data:
                      raise HTTPException(status_code=404, detail=f"Device {device_id} not found")
                  return data

              @app.get("/api/realtime/stream")
              def get_stream_events(count: int = 100):
                  """Get recent events from Redis Stream (set by NiFi)"""
                  try:
                      events = r.xrevrange('telemetry:stream', count=count)
                      return {
                          "events": [
                              {"id": e[0], "data": e[1]} for e in events
                          ],
                          "count": len(events)
                      }
                  except Exception as e:
                      return {"events": [], "count": 0, "note": "Stream not yet created"}

              @app.get("/api/realtime/stats")
              def get_realtime_stats():
                  """Get real-time statistics"""
                  device_count = len(list(r.scan_iter("device:*")))
                  stream_len = r.xlen('telemetry:stream') if r.exists('telemetry:stream') else 0
                  return {
                      "active_devices": device_count,
                      "stream_length": stream_len,
                      "redis_memory": r.info('memory').get('used_memory_human', 'N/A')
                  }
              EOF
              mkdir -p /app
              cd /app
              uvicorn main:app --host 0.0.0.0 --port 8000
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: dashboard-api
  namespace: edge
spec:
  selector:
    app: dashboard-api
  ports:
    - port: 8000
      targetPort: 8000
      protocol: TCP
  type: ClusterIP
