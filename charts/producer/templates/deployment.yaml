{{- if .Values.deployment.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "producer.fullname" . }}
  labels:
    {{- include "producer.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.deployment.replicas | default 1 }}
  selector:
    matchLabels:
      {{- include "producer.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "producer.selectorLabels" . | nindent 8 }}
    spec:
      containers:
      - name: producer
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command: ["/bin/sh", "-c"]
        args:
          - |
            pip install paho-mqtt redis && python3 -u /app/produce.py
        env:
        - name: MQTT_BROKER_HOST
          value: {{ .Values.mqtt.brokerHost | quote }}
        - name: MQTT_BROKER_PORT
          value: {{ .Values.mqtt.brokerPort | quote }}
        - name: MQTT_TOPIC
          value: {{ .Values.mqtt.topic | quote }}
        - name: MQTT_QOS
          value: {{ .Values.mqtt.qos | quote }}
        - name: DEVICE_COUNT
          value: {{ .Values.devices.count | quote }}
        - name: DEVICE_PREFIX
          value: {{ .Values.devices.prefix | quote }}
        - name: SIM_FREQUENCY
          value: {{ .Values.simulation.frequency | quote }}
        - name: SIM_DURATION
          value: "0"  # Run forever in deployment mode
        - name: SIM_BATCH_SIZE
          value: {{ .Values.simulation.batchSize | quote }}
        - name: ANOMALY_ENABLED
          value: {{ .Values.anomalies.enabled | quote }}
        - name: ANOMALY_PROBABILITY
          value: {{ .Values.anomalies.probability | quote }}
        - name: REDIS_ENABLED
          value: {{ .Values.redis.enabled | quote }}
        - name: REDIS_HOST
          value: {{ .Values.redis.host | quote }}
        - name: REDIS_PORT
          value: {{ .Values.redis.port | quote }}
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "producer.fullname" . }}-secrets
              key: redis-password
        - name: REDIS_TTL
          value: {{ .Values.redis.ttl | quote }}
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
        volumeMounts:
        - name: script-volume
          mountPath: /app
        livenessProbe:
          exec:
            command:
            - pgrep
            - -f
            - python3
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          exec:
            command:
            - pgrep
            - -f
            - python3
          initialDelaySeconds: 10
          periodSeconds: 10
      volumes:
      - name: script-volume
        configMap:
          name: {{ include "producer.fullname" . }}-script
{{- end }}
